\documentclass[xcolor=table]{beamer}

\usetheme[aspectratio=169]{Dresden}
\definecolor{cerulean}{rgb}{0.0, 0.48, 0.65}
%\definecolor{darkcyan}{rgb}{0.0, 0.55, 0.55}
\usecolortheme[named=cerulean]{structure}

\fontfamily{cmr}\selectfont

\usepackage{ragged2e}
\usepackage[brazilian]{babel}
\usepackage{graphicx}
\usepackage[authoryear]{natbib}
\usepackage{hyperref} 
%\usepackage{subfig}
%\usepackage{amssymb,amsfonts,amsmath,amsthm,euscript}
\usepackage{indentfirst}
%\usepackage{ulem}
\usepackage{dsfont}
%\usepackage{placeins}
%\usepackage{enumitem}
\usepackage{booktabs}
\usepackage{multirow}
\usepackage{array}


\newcommand{\R}{\mathds{R}}
\newcommand{\N}{\mathds{N}}
\newcommand{\B}{\mathds{B}}
\newcommand{\Perp}{\mathcal{P}}
\newcommand{\bs}[1]{\boldsymbol{#1}}

\newcommand{\red}[1]{\textcolor{red}{#1}}
\newcommand{\blue}[1]{\textcolor{blue}{#1}}


\title{Composição Automática de Músicas utilizando Redes Neurais Recorrentes}
\author[Hahn, N. M.]{Nicolas Mathias Hahn \\ \footnotesize Orientador: Guilherme Pumi}
\institute[IME-UFRGS]{Departamento de Estatística \\ Instituto de Matemática e Estatística \\ Universidade Federal do Rio Grande do Sul (UFRGS)}
\date{Outubro, 2022 \\ \tiny Porto Alegre - RS}

\begin{document}

    \begin{frame}
        \maketitle
    \end{frame}


\section{Introdução}
    \begin{frame}{Contextualização}
        \begin{columns}[onlytextwidth,t]
            \begin{column}{0.48\textwidth}
                \centering
                \begin{itemize}
                    \justifying
                    \item Composição algorítmica refere-se ao processo de criação de músicas com o mínimo de intervenção humana.
                    \item A obra \textit{Musikalisches Wurfelspiel} (\textit{Dice Music}), de Wolfgang Amadeus Mozart (1756-1791), utilizou tal processo.
                \end{itemize}
            \end{column}
            \begin{column}{0.48\textwidth}
                \centering
                \vspace{-1cm}
                \begin{figure}
                    \includegraphics[scale=0.32]{figuras/dice_music.PNG}
                    \caption{\textit{Dice Music}}
	            \end{figure}
            \end{column}
        \end{columns}
    \end{frame}
    
    \begin{frame}{Contextualização}
        \begin{columns}[onlytextwidth,t]
            \begin{column}{0.5\textwidth}
                \centering
                \vspace{-0.5cm}
                \begin{figure}
                    \includegraphics[scale=0.32]{figuras/reunion_board.PNG}
                    \caption{Tabuleiro de Xadrez com Foto Receptor}
	            \end{figure}
            \end{column}
            \begin{column}{0.46\textwidth}
                \centering
                \begin{itemize}
                    \justifying
                    \item A performance \textit{Reunion}, de John Cage (1912-1992), também utilizou composição automática.
                    \item David Cope (1941-), em 1981, criou o EMI (\textit{Experiments in Musical Intelligence}), um sistema com descrições de estilos composicionais capaz de criar os próprios.
                \end{itemize}
            \end{column}
        \end{columns}
    \end{frame}

    \begin{frame}{Literatura}
        \begin{itemize}
            \justifying
            \item Via de regra, o problema de composição musical automática é explorado com foco na composição musical em si.
            \item Detalhes técnicos como os impactos que as modificações nos parâmetros têm na composição final, ainda, são amplamente desconhecidos.
            \item Exemplos: \citet{agarwala2017}, \citet{kuang2021}.
        \end{itemize}
    \end{frame}
    
    \begin{frame}{Objetivos}
        \begin{itemize}
            \justifying
            \item Estudar o quão sensível é um modelo de rede neural, baseado em processamento de linguagem natural, construído para composição musical.
            \item A mensuração será feita com a perplexidade, uma medida oriunda da teoria da informação.
            \item Avaliar, de forma subjetiva, as peças musicais obtidas em relação à musicalidade e à qualidade.
        \end{itemize}
    \end{frame}



\section{Referencial Teórico}
    \begin{frame}{RNN - Redes Neurais Recorrentes}
        \begin{itemize}
            \item RNNs são um tipo de redes neurais criadas para processar séries temporais e outros tipos de dados sequenciais \citep{fan2021}.
        \end{itemize}
        \begin{figure}
           \includegraphics[scale=0.3]{figuras/rnn_hidden_state.pdf}
		    \caption{Diagrama de uma RNN \textit{Vanilla} \citep[adaptado de][]{goodfellow2016, kamath2019}}
	    \end{figure}
    \end{frame}

    \begin{frame}{LSTM - \textit{Long Short-Term Memory}}
        \begin{itemize}
            \justifying
            \item De acordo com \citet{goodfellow2016}, as LSTM fazem parte de uma classe de modelos chamada de RNN fechadas (\textit{gated RNN}).
            \item Os portões (\textit{gates}), que também são camadas da rede neural, controlam o fluxo de informação, mantendo ou descartando o estado oculto $\bs{h}_{t}$ a cada passo temporal \citep{kamath2019}.
            \item É uma das variantes de RNN desenvolvidas para contornar o problema de dissipação (ou explosão) do gradiente, que ocorre no ajuste da rede.
        \end{itemize}  
    \end{frame}
    
    \begin{frame}{LSTM - \textit{Long Short-Term Memory}}
       \begin{figure}
            \centering
            \includegraphics[scale=0.25]{figuras/lstm_cell.pdf}
	        \caption{Diagrama de uma LSTM. Considere $\sigma$ como a função de ativação \textit{logit} \citep[adaptado de][]{kamath2019}.}
        \end{figure}
    \end{frame}

    \begin{frame}{Função de Ativação}
    % https://tex.stackexchange.com/questions/391369/two-column-items-with-titles-in-a-beamer
        \begin{columns}[onlytextwidth,t]
            \begin{column}{0.48\textwidth}
                \centering
                \textbf{Sigmóide (\textit{logit})}
                
                \begin{figure}
                    \includegraphics[scale=0.12]{figuras/sigmoid.pdf}
	            \end{figure}
	               
	            $f: \R \rightarrow (0,1)$ dada por 
	            \[f(x) := \frac{1}{1 + e^{-x}}\]
	            
            \end{column}

            \begin{column}{0.48\textwidth}
                \centering
                \textbf{Tangente Hiperbólica (\textit{tanh})}
            
                \begin{figure}
                     \includegraphics[scale=0.12]{figuras/tanh.pdf}
	            \end{figure}
	            
	            $f:\R \rightarrow (-1,1)$ dada por 
                \[f(x) := \frac{e^{x}-e^{-x}}{e^{x}+e^{-x}}\]
 
            \end{column}
        \end{columns}
    \end{frame}

    \begin{frame}{Ajustando uma RNA}
        \begin{itemize}
            \justifying
            \item Os pesos da rede são ajustados por meio do método do gradiente descendente estocástico (SGD).
            \item Utiliza-se uma partição aleatória dos dados de treino, denominada lote.
            \item A taxa de aprendizagem $\epsilon$ define o tamanho do passo em direção ao gradiente negativo.
            \item Uma passagem pelo conjunto de dados de treinamento é denominada época.
        \end{itemize}
    \end{frame}

    \begin{frame}{PLN - Processamento de Linguagem Natural}
        \begin{itemize}
            \justifying
            \item Aplicação de métodos estatísticos e computacionais para modelar e extrair informações da linguagem humana \citep{kamath2019}.
            \item É importante testar os algoritmos em mais de uma linguagem, especialmente em linguagens com diferentes propriedades \citep{jurafsky2021}.
            \item Um modelo estatístico de linguagem é aquele que atribui probabilidades para uma sequência de \textit{tokens}. 
        \end{itemize}
    \end{frame}

    \begin{frame}{PLN - Perplexidade}
        \begin{itemize}
            \justifying
            \item A perplexidade $\Perp(W)=e^{H(\bs{W})}$ é uma medida para a avaliação intrínseca de um modelo de linguagem.
            \item Medidas menores de perplexidade são indicativas de uma predição melhor.
            \item A perplexidade de dois modelos de linguagem apenas podem ser comparadas se ambos utilizam o mesmo vocabulário.
        \end{itemize}
    \end{frame}

    \begin{frame}{Notação ABC}
        \vspace{0.1cm}
        \begin{itemize}
            \justifying
            \item Notação ABC é um sistema popular de notação musical baseada em texto para transcrever, publicar e compartilhar músicas, particularmente de forma \textit{online}. 
        \end{itemize}

        \begin{figure}
            \vspace{-0.5cm}
            \centering
            \includegraphics[scale=0.25]{figuras/abc_notation_example.pdf}
	        \caption{Exemplo de notação ABC convertendo em música.}
        \end{figure}
    \end{frame}

    \begin{frame}{\textit{Web Scraping}}
        \begin{itemize}
            \justifying
            \vspace{0.1cm}
            \item De acordo com \citet{lawson2015,patil2016}, envolve dois programas:
            \vspace{0.1cm}
            \begin{itemize}
                \item \textit{crawler}: sistematicamente coleta os dados da Internet;
                \item \textit{scraper}: extrai a informação relevante e armazena em uma base de dados.
            \end{itemize}
        \end{itemize}
        
        \begin{figure}
            \centering
            \includegraphics[scale=0.16]{figuras/spider_crawler.png}
	        \caption{\textit{Crawler} coletando páginas \textit{web}.}
        \end{figure}
        % https://www.scraping-bot.io/how-to-build-a-web-crawler/
    \end{frame}



\section{Modelagem}
    \begin{frame}{Bases de Dados - Fontes}
        \textbf{Irish}
        \begin{itemize}
            \justifying
            \item contém 817 músicas folclóricas irlandesas no formato \textit{.abc};
            \item versão disponibilizada pelo Instituto de Tecnologia de Massachusetts (MIT).
        \end{itemize}
        
        \textbf{ABC Notation}
        \begin{itemize}
            \justifying
            \item coleta, via \textit{web scraping}, do site \href{https://abcnotation.com/}{abcnotation.com};
            \item foram coletados $184.900$ músicas;
            \item selecionada uma amostra de $5.000$.
        \end{itemize}
    \end{frame}

    \begin{frame}{Bases de Dados - Tratamentos}
        \begin{itemize}
            \justifying
            \item \textbf{tratamento}: via expressões regulares, removeu-se caracteres que não afetam diretamente as músicas (título, letra de música);
            \item \textbf{união}: todas as músicas foram ``coladas'', como se fizessem parte de um único texto.
            \item \textbf{tokenização}: para cada caractere (\textit{token}) presente, foi criado um único índice.
        \end{itemize}
    \end{frame}

    \begin{frame}{Modelo - Arquitetura}
        \begin{itemize}
            \justifying
            \item Utilizou-se um modelo de RNN-LSTM, que foi ajustado com ambas as bases de dados de forma independente;
            \item Quatro camadas: entrada, \textit{Embedding}, LSTM e \textit{Dense};
            \item Foi feita uma divisão dos dados em 80\% treino e 20\% teste.
        \end{itemize}
    \end{frame}

    \begin{frame}{Modelo - Parâmetros (inicial)}
        \begin{itemize}
            \justifying
            \item 2000 épocas no ajuste do modelo;
            \item função perda: entropia cruzada;
            \item métrica de avaliação: perplexidade;
            \item segmentou-se em duas etapas.
        \end{itemize}
    \end{frame}
    
    \begin{frame}{Modelo - Parâmetros (1ª etapa)}
        \begin{itemize}
            \justifying
            \item fixou-se a função de ativação \textit{tanh} na camada LSTM;
            \item foram alterados os seguintes parâmetros e hiperparâmetros:
            \begin{itemize}
                \item \textit{vocab\_size} $\in \{64,125\}$;
                \item \textit{lstm\_units} $\in \{256,1024\}$;
                \item \textit{embedding\_dim} $\in \{256,512\}$;
                \item \textit{learning\_rate} $\in \{10^{-3},10^{-5}\}$;
                \item \textit{seq\_length} $\in \{50,200\}$;
                \item \textit{batch\_size} $\in \{4,16\}$.
            \end{itemize}
            \item foram ajustados 64 modelos, sendo 32 para cada base de dados.
        \end{itemize}
    \end{frame}
    
    \begin{frame}{Modelo - Parâmetros (2ª etapa)}
        \begin{itemize}
            \justifying
            \item selecionou-se os dois melhores e os dois piores modelos da 1ª etapa;
            \item critério: perplexidade;
            \item trocou-se função de ativação para \textit{logit}.
        \end{itemize}
    \end{frame}
    
    \begin{frame}{Processo Gerador de Música}
        \begin{enumerate}
            \justifying
            \item Construir um modelo com os devidos parâmetros; 
            \item Fixado o modelo, carregam-se os pesos de um modelo similar ajustado previamente;
            \item Fornecer uma sequência de caracteres inicial, no caso ``X:'';
            \item Iterativamente, o modelo estima um novo elemento para compor a sequência até atingir um comprimento definido;
            \item Extrair da sequência blocos de texto candidatos a músicas e, ao serem convertidos com sucesso, resultam em músicas.
        \end{enumerate}
    \end{frame}



\section{Resultados}
    \begin{frame}{Irish - 1ª Etapa}
        \begin{figure}
            \includegraphics[scale=0.38]{figuras/irish_tanh_corr.pdf}
            \caption{Correlação entre parâmetros e métricas para Irish}
        \end{figure}
    \end{frame}

    \begin{frame}{Irish - 2ª Etapa}
        \rowcolors{3}{white}{gray!25}
        \large
        \begin{table}
            %\caption{Irish: \textit{tanh} vs \textit{logit}}
            \centering
            \begin{tabular}{c|cc|cc}
                \toprule
                \multirow{2}{*}{idx} &
                \multicolumn{2}{c|}{\textit{train\_loss}} &
                \multicolumn{2}{c}{\textit{test\_perplexity}} \\
                & {\textit{tanh}} & {\textit{logit}} & {\textit{tanh}} & {\textit{logit}} \\
                \midrule
                5 & 2.964 & 3.021 & 24.709 & 27.576 \\
                7 & 2.963 & 3.135 & 20.401 & 24.726 \\
                11 & 0.982 & 1.195 & 2.835 & 3.549 \\
                25 & 1.171 & 1.389 & 2.752 & 3.263 \\
                \bottomrule
            \end{tabular}
        \end{table}
    \end{frame}

    \begin{frame}{ABC Notation - 1ª Etapa}
        \begin{figure}
            \includegraphics[scale=0.38]{figuras/abcnotation_tanh_corr.pdf}
            \caption{Correlação entre parâmetros e métricas para ABC Notation}
        \end{figure}
    \end{frame}

    \begin{frame}{ABC Notation - 2ª Etapa}
        \rowcolors{3}{white}{gray!25}
        \large
        \begin{table}
            %\caption{ABC Notation: \textit{tanh} vs \textit{logit}}
            \centering
            \begin{tabular}{c|cc|cc}
                \toprule
                \multirow{2}{*}{idx} &
                \multicolumn{2}{c}{\textit{train\_loss}} &
                \multicolumn{2}{c}{\textit{test\_perplexity}} \\
                & {\textit{tanh}} & {\textit{logit}} & {\textit{tanh}} & {\textit{logit}} \\
                \midrule
                8 & 3.628 & 3.670 & 31.707 & 33.038 \\
                6 & 3.522 & 3.571 & 35.991 & 37.849 \\
                20 & 1.350 & 1.616 & 3.971 & 5.142 \\
                28 & 1.305 & 1.585 & 3.940 & 4.960 \\
                \bottomrule
            \end{tabular}
        \end{table}
    \end{frame}

    \begin{frame}{Geração de Músicas}
        \vspace{-1cm}
        \begin{columns}[onlytextwidth,t]
            \begin{column}{0.48\textwidth}
                \centering
                \textbf{Irish}: 24 músicas
                \vspace{0.1cm}
                \begin{itemize}
                    \item $idx=11$: 10 músicas
                    \begin{itemize}
                        \item \textit{logit}: 4 músicas
                        \item \textit{tanh}: 6 músicas
                    \end{itemize}
                    \vspace{0.25cm}
                    \item $idx=25$: 14 músicas
                    \begin{itemize}
                        \item \textit{logit}: 6 músicas 
                        \item \textit{tanh}: 8 músicas
                    \end{itemize}
                \end{itemize}
            \end{column}

            \begin{column}{0.48\textwidth}
                \centering
                \textbf{ABC Notation}: 14 músicas
                \vspace{0.1cm}
                \begin{itemize}
                    \item $idx=20$: 8 músicas
                    \begin{itemize}
                        \item \textit{logit}: 4 músicas
                        \item \textit{tanh}: 4 músicas
                    \end{itemize}
                    \vspace{0.25cm}
                    \item $idx=28$: 6 músicas
                    \begin{itemize}
                        \item \textit{logit}: 1 músicas
                        \item \textit{tanh}: 5 músicas
                    \end{itemize}
                \end{itemize}
            \end{column}
        \end{columns}
    \end{frame}
    
    \begin{frame}{Percepções sobre as Músicas}
        \begin{columns}[onlytextwidth,t]
            \begin{column}{0.48\textwidth}
                \centering
                \textbf{Irish}
                \vspace{0.1cm}
                \begin{itemize}
                    \item trechos similares
                    \item voz única
                    \item musicalmente plausível
                \end{itemize}
            \end{column}

            \begin{column}{0.48\textwidth}
                \centering
                \textbf{ABC Notation}
                \vspace{0.1cm}
                \begin{itemize}
                    \item mais variabilidade
                    \item voz múltipla
                    \item musicalmente plausível
                \end{itemize}
            \end{column}
        \end{columns}
        
        \vspace{1cm}
        Os comentários feitos referente às composições geradas são as percepções do autor com seu limitado conhecimento musical.
    \end{frame}



\section{Considerações Finais}
    \begin{frame}{Resumo}
        \begin{itemize}
            \justifying
            \item Explorou-se o problema de composição automática de músicas. 
            \item Investigou-se a sensibilidade dos modelos via modificação dos parâmetros.
            \item Mediu-se impactos das mudanças via perplexidade.
            \item Gerou-se novos arquivos \textit{.abc} que, quando possível, foram convertidos em músicas.
        \end{itemize}
    \end{frame}
    
    \begin{frame}{Extensões}
        \begin{itemize}
            \justifying
            \item Modificar a arquitetura contemplando o aumento do número de camadas;
            \item Explorar outros perfis de redes, como a \textit{transformer} \citep{vaswani2017};
            \item Analisar detalhadamente características musicais das composições.
        \end{itemize}
    \end{frame}



%
    \begin{frame}[allowframebreaks]
        \frametitle{Referências}
        \bibliographystyle{apalike}
        \bibliography{biblio}
    \end{frame}


\end{document}